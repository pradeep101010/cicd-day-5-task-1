trigger:
- main

variables:
  location: 'East US'
  environment: 'dev'
  rg_name: '$(environment)-rg'
  app_service_plan_name: '$(environment)-asp'
  app_service_tier: 'Standard'
  app_service_size: 'S1'
  app_service_name: '$(environment)-app'

stages:
- stage: Terraform_CI
  displayName: 'Terraform CI'
  jobs:
  - job: Terraform
    displayName: 'Terraform Init, Format, Validate, Plan'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'

    - script: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
        sudo apt-add-repository "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
        sudo apt-get update && sudo apt-get install terraform -y
      displayName: 'Install Terraform'

    - task: AzureCLI@2
      inputs:
        azureSubscription: '<YOUR_SERVICE_CONNECTION>'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "Azure login successful"
      displayName: 'Azure Login'

    - script: |
        terraform init
      displayName: 'Terraform Init'

    - script: |
        terraform fmt -check
      displayName: 'Terraform Format'

    - script: |
        if [ "$(environment)" = "prod" ]; then
          terraform validate -json | jq -e '.diagnostics[] | select(.severity=="warning") | .summary' && exit 1 || terraform validate
        else
          terraform validate
        fi
      displayName: 'Terraform Validate'

    - script: |
        terraform plan -out=tfplan
      displayName: 'Terraform Plan'

    - publish: tfplan
      artifact: terraform_plan
