trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: terraformVersion
    value: '1.6.0'
  - name: workingDirectory
    value: '$(Pipeline.Workspace)'

stages:
  - stage: TerraformCD
    displayName: 'Terraform CD - Apply'
    jobs:
      - deployment: TerraformApply
        displayName: 'Terraform Apply'
        environment: '$(environment)'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: TerraformInstaller@0
                  displayName: 'Install Terraform'
                  inputs:
                    terraformVersion: $(terraformVersion)

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Terraform Plan'
                  inputs:
                    buildType: 'specific'
                    project: '$(System.TeamProject)'
                    definition: '$(ciPipelineId)'
                    buildVersionToDownload: 'latest'
                    artifactName: 'terraform-plan-$(environment)'
                    targetPath: '$(workingDirectory)/plan'

                - task: DownloadPipelineArtifact@2
                  displayName: 'Download Terraform Files'
                  inputs:
                    buildType: 'specific'
                    project: '$(System.TeamProject)'
                    definition: '$(ciPipelineId)'
                    buildVersionToDownload: 'latest'
                    artifactName: 'terraform-files-$(environment)'
                    targetPath: '$(workingDirectory)/terraform'

                - task: AzureCLI@2
                  displayName: 'Azure Authentication'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Authenticated to Azure"
                      az account show
                      echo "Target Environment: $(environment)"

                - script: |
                    cd $(workingDirectory)/terraform
                    terraform init \
                      -backend-config="resource_group_name=$(tfStateResourceGroup)" \
                      -backend-config="storage_account_name=$(tfStateStorageAccount)" \
                      -backend-config="container_name=$(tfStateContainer)" \
                      -backend-config="key=$(environment).terraform.tfstate"
                  displayName: 'Terraform Init'
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

                - script: |
                    cd $(workingDirectory)/terraform
                    cp $(workingDirectory)/plan/tfplan .
                    
                    echo "Displaying plan to be applied:"
                    terraform show tfplan
                  displayName: 'Show Terraform Plan'
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

                # Manual approval is handled by the environment configuration in Azure DevOps
                # Configure approvals in: Pipelines > Environments > [environment-name] > Approvals and checks

                - script: |
                    cd $(workingDirectory)/terraform
                    echo "Applying Terraform plan for environment: $(environment)"
                    terraform apply -auto-approve tfplan
                    
                    if [ $? -eq 0 ]; then
                      echo "##vso[task.setvariable variable=deploymentStatus]Success"
                      echo "Terraform apply completed successfully"
                    else
                      echo "##vso[task.setvariable variable=deploymentStatus]Failed"
                      echo "##vso[task.logissue type=error]Terraform apply failed"
                      exit 1
                    fi
                  displayName: 'Terraform Apply'
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

                - script: |
                    cd $(workingDirectory)/terraform
                    echo "Deployment Outputs:"
                    terraform output -json > outputs.json
                    cat outputs.json
                    
                    echo "=== Deployment Summary ==="
                    echo "Environment: $(environment)"
                    echo "Resource Group: $(terraform output -raw resource_group_name)"
                    echo "App Service URL: $(terraform output -raw app_service_url)"
                  displayName: 'Display Deployment Outputs'
                  env:
                    ARM_CLIENT_ID: $(ARM_CLIENT_ID)
                    ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
                    ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                    ARM_TENANT_ID: $(ARM_TENANT_ID)

                - task: AzureCLI@2
                  displayName: 'Verify Deployment'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Verifying deployed resources..."
                      
                      # Get resource group name from Terraform output
                      cd $(workingDirectory)/terraform
                      RG_NAME=$(terraform output -raw resource_group_name)
                      APP_NAME=$(terraform output -raw app_service_name)
                      
                      echo "Checking Resource Group: $RG_NAME"
                      az group show --name $RG_NAME --output table
                      
                      echo "Checking App Service: $APP_NAME"
                      az webapp show --name $APP_NAME --resource-group $RG_NAME --output table
                      
                      echo "App Service Status:"
                      az webapp show --name $APP_NAME --resource-group $RG_NAME --query "state" -o tsv
                      
                      echo "Deployment verification completed successfully"
