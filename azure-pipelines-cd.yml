trigger: none
pr: none

resources:
  pipelines:
    - pipeline: ciPipeline
      source: pradeep101010.pradeep-new-cicd-pipeline
      trigger:
        branches:
          include:
            - main
            - develop

stages:
- stage: Terraform_CD
  displayName: CD - Apply Terraform Plan
  jobs:
  - deployment: ApplyPlan
    displayName: Apply Terraform Plan
    environment: 'dev-env'
    pool:
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:
          steps:

          # Install Terraform
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.5.7'

          # Azure authentication
          - task: AzureCLI@2
            displayName: 'Azure Login'
            inputs:
              azureSubscription: 'pradeep-last-sc'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Logged into Azure:"
                az account show

          ############################################
          # DOWNLOAD ARTIFACTS FROM CI PIPELINE RUN #
          ############################################

          # Download full Terraform folder (includes .tf files + lock)
          - task: DownloadPipelineArtifact@2
            displayName: "Download Terraform folder"
            inputs:
              buildType: "specific"
              project: "$(System.TeamProjectId)"
              pipeline: "$(resources.pipeline.ciPipeline.pipelineId)"
              runVersion: "specific"
              runId: "$(resources.pipeline.ciPipeline.runId)"
              artifact: "terraform"
              path: "$(Pipeline.Workspace)/terraform"

          # Optional: download individual artifacts if you want logs separately
          - task: DownloadPipelineArtifact@2
            displayName: "Download tfplan binary"
            inputs:
              buildType: "specific"
              project: "$(System.TeamProjectId)"
              pipeline: "$(resources.pipeline.ciPipeline.pipelineId)"
              runVersion: "specific"
              runId: "$(resources.pipeline.ciPipeline.runId)"
              artifact: "tfplan"
              path: "$(Pipeline.Workspace)/tfplan"

          - task: DownloadPipelineArtifact@2
            displayName: "Download plan json"
            inputs:
              buildType: "specific"
              project: "$(System.TeamProjectId)"
              pipeline: "$(resources.pipeline.ciPipeline.pipelineId)"
              runVersion: "specific"
              runId: "$(resources.pipeline.ciPipeline.runId)"
              artifact: "tfplan_json"
              path: "$(Pipeline.Workspace)/tfplan_json"

          - task: DownloadPipelineArtifact@2
            displayName: "Download plan log"
            inputs:
              buildType: "specific"
              project: "$(System.TeamProjectId)"
              pipeline: "$(resources.pipeline.ciPipeline.pipelineId)"
              runVersion: "specific"
              runId: "$(resources.pipeline.ciPipeline.runId)"
              artifact: "planlog"
              path: "$(Pipeline.Workspace)/planlog"

          ############################################
          # RECREATE TF VARIABLES USED IN CI         #
          ############################################

          - script: |
              echo "Recreating Terraform variables used in CI..."

              export TF_VAR_resource_group_name="pradeep-rg"
              export TF_VAR_location="eastus"
              export TF_VAR_app_service_plan_name="pradeep-plan"
              export TF_VAR_app_service_plan_tier="Standard"
              export TF_VAR_app_service_plan_size="S1"
              export TF_VAR_app_service_name="pradeep-app"
              export TF_VAR_linux_fx_version="DOTNETCORE|7.0"

              # Recreate ci.tfvars inside terraform folder
              echo 'tags = {"env":"dev","owner":"pradeep"}' > $(Pipeline.Workspace)/terraform/ci.tfvars

              echo "Previewing plan changes..."
              jq '.resource_changes[]? | {type:.type, name:.name, action:.change.actions}' \
                 $(Pipeline.Workspace)/tfplan_json/tfplan.json || true
            displayName: "Recreate TF vars & preview plan"

          ############################################
          # APPLY TERRAFORM PLAN                      #
          ############################################

          - script: |
              cd $(Pipeline.Workspace)/terraform
              
              echo "Initializing Terraform..."
              terraform init -input=false

              echo "Applying Terraform plan..."
              terraform apply -input=false $(Pipeline.Workspace)/tfplan/tfplan.binary
            displayName: "Terraform Apply"
            env:
              TF_IN_AUTOMATION: "1"
