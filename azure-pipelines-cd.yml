trigger: none
pr: none

resources:
  pipelines:
    - pipeline: ciPipeline
      source: pradeep101010.pradeep-new-cicd-pipeline
      trigger:
        branches:
          include:
            - main
            - develop

stages:
- stage: Terraform_CD
  displayName: CD - Apply Terraform Plan
  jobs:
  - deployment: ApplyPlan
    displayName: Apply Terraform Plan
    environment: 'dev-env'
    pool:
      vmImage: 'ubuntu-latest'

    strategy:
      runOnce:
        deploy:
          steps:

          ############################################
          # Install Terraform
          ############################################
          - task: TerraformInstaller@1
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: '1.5.7'

          ############################################
          # Azure login
          ############################################
          - task: AzureCLI@2
            displayName: 'Azure Login'
            inputs:
              azureSubscription: 'pradeep-last-sc'
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Logged into Azure:"
                az account show

          ############################################
          # Download full terraform configuration from CI
          ############################################
          - task: DownloadPipelineArtifact@2
            displayName: 'Download terraform folder'
            inputs:
              buildType: 'specific'
              project: '$(System.TeamProjectId)'
              pipeline: '$(resources.pipeline.ciPipeline.pipelineId)'
              runVersion: 'specific'
              runId: '$(resources.pipeline.ciPipeline.runId)'
              artifact: 'terraform'
              path: '$(Pipeline.Workspace)/terraform'

          ############################################
          # Recreate TF_VARs
          ############################################
          - script: |
              echo "Setting Terraform variables..."
              export TF_VAR_resource_group_name="pradeep-rg"
              export TF_VAR_location="eastus"
              export TF_VAR_app_service_plan_name="pradeep-plan"
              export TF_VAR_app_service_plan_tier="Standard"
              export TF_VAR_app_service_plan_size="S1"
              export TF_VAR_app_service_name="pradeep-app"
              export TF_VAR_linux_fx_version="DOTNETCORE|7.0"
            displayName: 'Set TF_VARs'

          ############################################
          # Fix permissions for provider binaries
          ############################################
          - script: |
              echo "Fixing permissions for Terraform provider binaries..."
              chmod -R +x $(Pipeline.Workspace)/terraform/.terraform/providers/
            displayName: 'Fix Terraform provider permissions'

          ############################################
          # Initialize Terraform and create plan in CD
          ############################################
          - script: |
              cd $(Pipeline.Workspace)/terraform
              echo "Initializing Terraform..."
              terraform init -input=false -upgrade
              echo "Creating Terraform plan..."
              terraform plan -input=false -var-file=ci.tfvars -out=tfplan_cd.binary
              terraform show -json tfplan_cd.binary > tfplan_cd.json
            displayName: 'Terraform Init & Plan in CD'
            env:
              TF_IN_AUTOMATION: '1'

          ############################################
          # Apply Terraform plan created in CD
          ############################################
          - script: |
              cd $(Pipeline.Workspace)/terraform
              echo "Applying Terraform plan..."
              terraform apply -input=false tfplan_cd.binary
            displayName: 'Terraform Apply in CD'
            env:
              TF_IN_AUTOMATION: '1'
